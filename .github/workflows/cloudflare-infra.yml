name: cloudflare-infra

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/cloudflare-infra.yml"
      - "scripts/cloudflare/**"
      - "workers/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  apply:
    name: Apply DNS + Worker Routing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install --yes jq
          fi
      - name: Apply Cloudflare infrastructure
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_ZONE_ID_TYRUM_AI: ${{ secrets.CLOUDFLARE_ZONE_ID_TYRUM_AI }}
          CLOUDFLARE_ZONE_ID_TYRUM_COM: ${{ secrets.CLOUDFLARE_ZONE_ID_TYRUM_COM }}
          MARKETING_PAGES_HOST: ${{ vars.MARKETING_PAGES_HOST }}
          DOCS_PAGES_HOST: ${{ vars.DOCS_PAGES_HOST }}
          WORKER_NAME: ${{ vars.WORKER_NAME }}
          WORKER_COMPAT_DATE: ${{ vars.WORKER_COMPAT_DATE }}
        run: bash scripts/cloudflare/apply-infra.sh
